<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selamat Hari Valentine ğŸ’</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;600&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --pink: #ff6b9d;
            --rose: #c44569;
            --glass: rgba(255,255,255,0.18);
            --glass-border: rgba(255,255,255,0.32);
        }

        html { height: 100%; }

        body {
            font-family: 'Lato', sans-serif;
            font-size: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #c44569 100%);
            min-height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 15px;
            position: relative;
            overflow-x: hidden;
        }

        #heartCanvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        #setupPage {
            max-width: 560px;
            width: 100%;
            z-index: 10;
            position: relative;
        }
        #setupPage .page-title {
            text-align: center;
            color: #fff;
            font-family: 'Playfair Display', serif;
            font-size: 2.2em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.3);
            letter-spacing: 2px;
            padding-top: 5%;
        }
        #setupPage .page-subtitle {
            text-align: center;
            color: rgba(255,255,255,0.85);
            font-size: 1em;
            margin-bottom: 24px;
            font-style: italic;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border-radius: 28px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 12px 40px rgba(0,0,0,0.22);
            padding: 32px 28px;
        }

        .setup-field { margin-bottom: 22px; }
        .setup-field label {
            display: block;
            color: #fff;
            font-size: 0.95em;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .setup-field input,
        .setup-field textarea {
            width: 100%;
            background: rgba(255,255,255,0.92);
            border: 2px solid rgba(255,255,255,0.45);
            border-radius: 13px;
            padding: 13px 16px;
            font-family: 'Lato', sans-serif;
            font-size: 0.95em;
            color: #333;
            transition: all 0.3s;
        }
        .setup-field textarea { min-height: 100px; resize: vertical; }
        .setup-field input:focus,
        .setup-field textarea:focus {
            outline: none;
            border-color: var(--pink);
            box-shadow: 0 0 0 3px rgba(255,107,157,0.25);
        }
        .setup-field input::placeholder,
        .setup-field textarea::placeholder { color: #aaa; font-style: italic; }

        .phone-hint {
            font-size: 0.8em;
            color: rgba(255,255,255,0.72);
            margin-top: 5px;
            font-style: italic;
        }

        .btn-main {
            width: 100%;
            background: linear-gradient(135deg, var(--pink) 0%, var(--rose) 100%);
            color: #fff;
            border: none;
            padding: 15px;
            font-size: 1.05em;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            box-shadow: 0 6px 22px rgba(255,105,180,0.45);
            transition: all 0.3s;
            letter-spacing: 0.5px;
        }
        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 10px 32px rgba(255,105,180,0.6); }
        .btn-main:active { transform: translateY(-1px); }
        .btn-main:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #linkBox {
            display: none;
            margin-top: 22px;
            background: rgba(255,255,255,0.96);
            border-radius: 18px;
            padding: 22px;
            border: 2px solid rgba(255,105,180,0.35);
        }
        #linkBox h4 {
            color: var(--rose);
            font-family: 'Playfair Display', serif;
            margin-bottom: 10px;
            font-size: 1.05em;
            text-align: center;
        }
        .link-info {
            text-align: center;
            color: #666;
            font-size: 0.85em;
            margin-bottom: 12px;
            font-style: italic;
        }
        .link-info .short-url {
            color: var(--rose);
            font-weight: 700;
            font-size: 1.1em;
            display: block;
            margin-top: 6px;
        }
        #generatedLink {
            width: 100%;
            background: #fff5f9;
            border: 1px solid rgba(255,105,180,0.3);
            border-radius: 10px;
            padding: 11px 14px;
            font-size: 0.85em;
            color: #555;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            margin-bottom: 13px;
            min-height: 44px;
        }
        .btn-copy {
            width: 100%;
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: #fff;
            border: none;
            padding: 12px;
            font-size: 0.95em;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Lato', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-copy:hover { transform: translateY(-2px); opacity: 0.9; }
        #copyFeedback {
            text-align: center;
            color: var(--rose);
            font-size: 0.85em;
            margin-top: 8px;
            min-height: 20px;
            font-weight: 600;
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid var(--pink);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #cardPage {
            max-width: 640px;
            width: 100%;
            z-index: 10;
            display: none;
            position: relative;
        }
        #cardPage .page-title {
            text-align: center;
            color: #fff;
            font-family: 'Playfair Display', serif;
            font-size: 1.99em;
            margin-bottom: 12px;
            text-shadow: 2px 2px 12px rgba(0,0,0,0.3);
            letter-spacing: 2px;
            padding-top: 2%;
        }

        .rose-container {
            text-align: center;
            margin-bottom: 12px;
        }
        .rose-container img {
            width: 90px; height: 90px;
            object-fit: contain;
            filter: drop-shadow(0 10px 25px rgba(0,0,0,0.3));
            animation: bloom 3s ease-in-out infinite;
        }
        .rose-container .flower-emoji {
            font-size: 70px;
            display: none;
            animation: bloom 3s ease-in-out infinite;
            line-height: 1.2;
        }
        @keyframes bloom {
            0%,100% { transform: scale(1) rotate(0deg); }
            50%      { transform: scale(1.06) rotate(2deg); }
        }

        .message-box {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 24px 22px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.28);
            position: relative;
        }
        .message-box::before {
            content: '\201C';
            font-size: 4.5em;
            position: absolute;
            top: -6px; left: 14px;
            color: rgba(255,255,255,0.25);
            font-family: Georgia, serif;
            line-height: 0.8;
        }
        .message-box h3 {
            color: #ffe0eb;
            font-family: 'Playfair Display', serif;
            font-size: 1.1em;
            margin-bottom: 14px;
            text-align: center;
        }
        .message-content {
            color: #bd093c;
            font-size: 1em;
            line-height: 1.85;
            text-align: left;
            font-style: normal;
            font-weight: 1000;
            text-shadow: 0px 1px 3px rgba(255,255,255,0.4);
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            padding: 0 8px;
        }
        .author {
            text-align: right;
            margin-top: 18px;
            color: rgb(49 49 49 / 92%);
            font-size: 0.95em;
            font-style: italic;
            font-weight: 600;
            padding-right: 8px;
        }

        .reply-box {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 16px 18px;
            border: 1px solid rgba(255,255,255,0.28);
        }
        .reply-box h3 {
            color: #fff;
            font-family: 'Playfair Display', serif;
            font-size: 1.2em;
            margin-bottom: 16px;
            text-align: center;
        }
        .reply-box label {
            display: block;
            color: rgba(255,255,255,0.9);
            font-size: 0.95em;
            margin-bottom: 8px;
        }
        .reply-box textarea {
            width: 100%;
            min-height: 90px;
            background: rgba(255,255,255,0.92);
            border: 2px solid rgba(255,255,255,0.45);
            border-radius: 13px;
            padding: 13px;
            font-family: 'Lato', sans-serif;
            font-size: 1em;
            color: #333;
            resize: vertical;
            transition: all 0.3s;
        }
        .reply-box textarea:focus {
            outline: none;
            border-color: var(--pink);
            box-shadow: 0 0 0 3px rgba(255,107,157,0.25);
        }
        .reply-box textarea::placeholder { color: #aaa; font-style: italic; }

        .send-btn-wrap { margin-top: 16px; text-align: center; }
        .btn-send {
            background: linear-gradient(135deg, var(--pink) 0%, var(--rose) 100%);
            color: #fff;
            border: none;
            padding: 14px 48px;
            font-size: 1.05em;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            box-shadow: 0 6px 22px rgba(255,105,180,0.45);
            transition: all 0.3s;
        }
        .btn-send:hover { transform: translateY(-3px); box-shadow: 0 10px 32px rgba(255,105,180,0.6); }

        @media (max-width: 600px) {
            body { font-size: 16px; padding: 16px 12px; }
            #setupPage .page-title, #cardPage .page-title { font-size: 1.6em; letter-spacing: 1px; margin-bottom: 10px; }
            .glass-card { padding: 20px 16px; border-radius: 20px; }
            .rose-container { margin-bottom: 10px; }
            .rose-container img { width: 80px; height: 80px; }
            .message-box { padding: 20px 16px; margin-bottom: 10px; }
            .message-box h3 { font-size: 1.05em; margin-bottom: 12px; }
            .message-content { 
                font-size: 0.95em; 
                line-height: 1.75;
                padding: 0 4px;
            }
            .author { 
                font-size: 0.9em; 
                margin-top: 16px;
                padding-right: 4px;
            }
            .reply-box { padding: 16px 14px; }
            .reply-box h3 { font-size: 1.05em; margin-bottom: 12px; }
            .reply-box label { font-size: 0.95em; }
            .reply-box textarea { font-size: 1em; }
            .btn-send { width: 100%; padding: 13px; font-size: 1em; }
        }
        @media (max-width: 380px) {
            body { font-size: 14px; padding: 12px 10px; }
            #setupPage .page-title, #cardPage .page-title { font-size: 1.4em; }
            .message-content { 
                font-size: 0.9em; 
                line-height: 1.65;
            }
        }
    </style>
</head>
<body>

<canvas id="heartCanvas"></canvas>

<div id="setupPage">
    <h1 class="page-title">BUAT KARTU VALENTINE</h1>
    <p class="page-subtitle">Buat kartu spesial & bagikan linknya ke orang tersayang</p>

    <div class="glass-card">
        <div class="setup-field">
            <label>ğŸ“± Nomor WhatsApp Kamu (Pengirim)</label>
            <input type="tel" id="senderPhone" maxlength="16" />
            <p class="phone-hint">Nomor ini digunakan untuk menerima balasan. Tidak ditampilkan ke penerima.</p>
        </div>

        <div class="setup-field">
            <label>ğŸ’Œ Pesan Valentine untuk Dia</label>
            <textarea id="customMessage"
                placeholder="Tulis pesan spesial dari hati kamu...&#10;&#10;Contoh: Kamu adalah cahaya dalam hari-hariku ğŸŒ¹"></textarea>
        </div>

        <div class="setup-field">
            <label>ğŸ‘¤ Nama Pengirim (opsional)</label>
            <input type="text" id="senderName"
                placeholder="Nama kamu (atau kosongkan jika misterius ğŸ˜Š)" />
        </div>

        <button class="btn-main" onclick="generateLink()" id="generateBtn">
            ğŸ’ Buat Kartu & Dapatkan Link
        </button>

        <div id="linkBox">
            <h4>âœ¨ Link Kartu Valentine Sudah Siap!</h4>
            <p class="link-info">
                Link pendek siap dishare:
                <span class="short-url" id="shortUrlDisplay"></span>
            </p>
            <div id="generatedLink"></div>
            <button class="btn-copy" onclick="copyLink()">ğŸ“‹ Salin Link Pendek</button>
            <p id="copyFeedback"></p>
        </div>
    </div>
</div>

<div id="cardPage">
    <h1 class="page-title">ğŸ’ SELAMAT HARI VALENTINE ğŸ’</h1>

    <div class="glass-card">
        <div class="rose-container">
            <img src="bunga.png" alt="Bunga Valentine"
                 onerror="this.style.display='none'; document.getElementById('flowerEmoji').style.display='block';">
            <div class="flower-emoji" id="flowerEmoji">ğŸŒ¹</div>
        </div>

        <div class="message-box">
            <h3>ğŸ’Œ Pesan Untukmu</h3>
            <div class="message-content" id="displayMessage"></div>
        </div>

        <div class="reply-box">
            <h3>ğŸ’¬ Tuliskan Balasanmu</h3>
            <label for="replyMessage">ğŸ’Œ Balasan kamu:</label>
            <textarea id="replyMessage"
                placeholder="Tulis balasan cinta kamu di sini... ğŸ’•"></textarea>
            <div class="send-btn-wrap">
                <button class="btn-send" onclick="sendReply()">
                    ğŸ’• Kirim Balasan
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLOATING HEARTS ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
    var canvas = document.getElementById('heartCanvas');
    var ctx    = canvas.getContext('2d');
    var hearts = [];

    function resize() {
        canvas.width  = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    function Heart() {
        this.reset();
    }
    Heart.prototype.reset = function() {
        this.x     = Math.random() * canvas.width;
        this.y     = canvas.height + 20;
        this.size  = 8 + Math.random() * 14;
        this.speed = 0.6 + Math.random() * 1.2;
        this.alpha = 0.5 + Math.random() * 0.5;
        this.drift = (Math.random() - 0.5) * 0.8;
        this.angle = Math.random() * Math.PI * 2;
        this.spin  = (Math.random() - 0.5) * 0.04;
    };
    Heart.prototype.update = function() {
        this.y     -= this.speed;
        this.x     += this.drift;
        this.angle += this.spin;
        this.alpha -= 0.003;
        if (this.y < -30 || this.alpha <= 0) this.reset();
    };
    Heart.prototype.draw = function() {
        ctx.save();
        ctx.globalAlpha = Math.max(0, this.alpha);
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.scale(this.size / 10, this.size / 10);
        ctx.fillStyle = 'rgba(255, 105, 180, 0.75)';
        ctx.beginPath();
        ctx.moveTo(0, -3);
        ctx.bezierCurveTo( 5, -8,  10, -3,   0,  5);
        ctx.bezierCurveTo(-10, -3, -5, -8,    0, -3);
        ctx.fill();
        ctx.restore();
    };

    for (var i = 0; i < 20; i++) {
        var h = new Heart();
        h.y = Math.random() * canvas.height;
        hearts.push(h);
    }

    function addHeart() {
        if (hearts.length < 35) hearts.push(new Heart());
    }
    setInterval(addHeart, 500);

    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (var i = 0; i < hearts.length; i++) {
            hearts[i].update();
            hearts[i].draw();
        }
        requestAnimationFrame(animate);
    }
    animate();
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHONE NORMALIZER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function normalizePhone(phone) {
    var p = phone.replace(/[^0-9]/g, '');
    if      (p.startsWith('08'))  p = '62' + p.substring(1);
    else if (p.startsWith('8'))   p = '62' + p;
    else if (p.startsWith('0'))   p = '62' + p.substring(1);
    else if (!p.startsWith('62')) p = '62' + p;
    return p;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KOMPRESI LZString - untuk link lebih pendek
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var LZString=function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",t={},i={compressToBase64:function(o){if(null==o)return"";var r=i._compress(o,6,function(o){return n.charAt(o)});switch(r.length%4){default:case 0:return r;case 1:return r+"===";case 2:return r+"==";case 3:return r+"="}},decompressFromBase64:function(r){return null==r?"":""==r?null:i._decompress(r.length,32,function(e){return o(n,r.charAt(e))})},compressToUTF16:function(o){return null==o?"":i._compress(o,15,function(o){return r(o+32)})+" "},decompressFromUTF16:function(o){return null==o?"":""==o?null:i._decompress(o.length,16384,function(r){return o.charCodeAt(r)-32})},compressToUint8Array:function(o){for(var r=i.compress(o),n=new Uint8Array(2*r.length),e=0,t=r.length;t>e;e++){var s=r.charCodeAt(e);n[2*e]=s>>>8,n[2*e+1]=s%256}return n},decompressFromUint8Array:function(o){if(null===o||void 0===o)return i.decompress(o);for(var n=new Array(o.length/2),e=0,t=n.length;t>e;e++)n[e]=256*o[2*e]+o[2*e+1];var s=[];return n.forEach(function(o){s.push(r(o))}),i.decompress(s.join(""))},compressToEncodedURIComponent:function(o){return null==o?"":i._compress(o,6,function(o){return e.charAt(o)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:(r=r.replace(/ /g,"+"),i._decompress(r.length,32,function(n){return o(e,r.charAt(n))}))},compress:function(o){return i._compress(o,16,function(o){return r(o)})},_compress:function(o,r,n){if(null==o)return"";var e,t,i,s={},p={},u="",c="",a="",l=2,f=3,h=2,d=[],m=0,v=0;for(i=0;i<o.length;i+=1)if(u=o.charAt(i),Object.prototype.hasOwnProperty.call(s,u)||(s[u]=f++,p[u]=!0),c=a+u,Object.prototype.hasOwnProperty.call(s,c))a=c;else{if(Object.prototype.hasOwnProperty.call(p,a)){if(a.charCodeAt(0)<256){for(e=0;h>e;e++)m<<=1,v==r-1?(v=0,d.push(n(m)),m=0):v++;for(t=a.charCodeAt(0),e=0;8>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;h>e;e++)m=m<<1|t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=a.charCodeAt(0),e=0;16>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete p[a]}else for(t=s[a],e=0;h>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;l--,0==l&&(l=Math.pow(2,h),h++),s[c]=f++,a=String(u)}if(""!==a){if(Object.prototype.hasOwnProperty.call(p,a)){if(a.charCodeAt(0)<256){for(e=0;h>e;e++)m<<=1,v==r-1?(v=0,d.push(n(m)),m=0):v++;for(t=a.charCodeAt(0),e=0;8>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;h>e;e++)m=m<<1|t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=a.charCodeAt(0),e=0;16>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete p[a]}else for(t=s[a],e=0;h>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;l--,0==l&&(l=Math.pow(2,h),h++)}for(t=2,e=0;h>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;for(;;){if(m<<=1,v==r-1){d.push(n(m));break}v++}return d.join("")},decompress:function(o){return null==o?"":""==o?null:i._decompress(o.length,32768,function(r){return o.charCodeAt(r)})},_decompress:function(o,n,e){var t,i,s,p,u,c,a,l,f=[],h=4,d=4,m=3,v="",w=[],A={val:e(0),position:n,index:1};for(i=0;3>i;i+=1)f[i]=i;for(p=0,c=Math.pow(2,2),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;switch(t=p){case 0:for(p=0,c=Math.pow(2,8),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;l=r(p);break;case 1:for(p=0,c=Math.pow(2,16),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;l=r(p);break;case 2:return""}for(f[3]=l,s=l,w.push(l);;){if(A.index>o)return"";for(p=0,c=Math.pow(2,m),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;switch(l=p){case 0:for(p=0,c=Math.pow(2,8),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;f[d++]=r(p),l=d-1,h--;break;case 1:for(p=0,c=Math.pow(2,16),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;f[d++]=r(p),l=d-1,h--;break;case 2:return w.join("")}if(0==h&&(h=Math.pow(2,m),m++),f[l])v=f[l];else{if(l!==d)return null;v=s+s.charAt(0)}w.push(v),f[d++]=s+v.charAt(0),h--,s=v,0==h&&(h=Math.pow(2,m),m++)}}};return i}();"function"==typeof define&&define.amd?define(function(){return LZString}):"undefined"!=typeof module&&null!=module&&(module.exports=LZString);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENKRIPSI DENGAN KOMPRESI MAKSIMAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function encryptData(phone, message, name) {
    var data = {
        w: phone,
        m: message,
        f: name || ''
    };
    var jsonStr = JSON.stringify(data);
    var compressed = LZString.compressToEncodedURIComponent(jsonStr);
    return compressed;
}

function decryptData(encoded) {
    try {
        var jsonStr = LZString.decompressFromEncodedURIComponent(encoded);
        if (!jsonStr) return null;
        return JSON.parse(jsonStr);
    } catch(e) {
        return null;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MULTI-SERVICE URL SHORTENER dengan fallback chain
//  Prioritas: is.gd â†’ TinyURL â†’ V.gd â†’ Cuttly â†’ T.ly
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function shortenURL(longUrl) {
    // 1. is.gd (paling reliable, gratis, tanpa registrasi)
    try {
        var response = await fetch('https://is.gd/create.php?format=json&url=' + encodeURIComponent(longUrl));
        var data = await response.json();
        if (data.shorturl) return data.shorturl;
    } catch(e) { console.log('is.gd failed, trying next...'); }

    // 2. V.gd (sama seperti is.gd tapi domain berbeda)
    try {
        var response = await fetch('https://v.gd/create.php?format=json&url=' + encodeURIComponent(longUrl));
        var data = await response.json();
        if (data.shorturl) return data.shorturl;
    } catch(e) { console.log('v.gd failed, trying next...'); }

    // 3. TinyURL
    try {
        var response = await fetch('https://tinyurl.com/api-create.php?url=' + encodeURIComponent(longUrl));
        var shortUrl = await response.text();
        if (shortUrl && shortUrl.includes('tinyurl.com')) return shortUrl.trim();
    } catch(e) { console.log('TinyURL failed, trying next...'); }

    // 4. Cuttly (perlu API key gratis tapi bisa tanpa key untuk basic)
    try {
        var response = await fetch('https://cutt.ly/api/api.php?short=' + encodeURIComponent(longUrl));
        var data = await response.json();
        if (data && data.url && data.url.shortLink) return data.url.shortLink;
    } catch(e) { console.log('Cuttly failed, trying next...'); }

    // 5. T.ly (backup terakhir)
    try {
        var response = await fetch('https://t.ly/api/v1/link/shorten', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ long_url: longUrl })
        });
        var data = await response.json();
        if (data && data.short_url) return data.short_url;
    } catch(e) { console.log('T.ly failed'); }

    // Jika semua gagal, return URL original
    console.log('All shorteners failed, returning original URL');
    return longUrl;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP PAGE â€” buat link
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateLink() {
    var phone   = document.getElementById('senderPhone').value.trim();
    var message = document.getElementById('customMessage').value.trim();
    var name    = document.getElementById('senderName').value.trim();
    var btn     = document.getElementById('generateBtn');

    if (!phone) {
        alert('ğŸ“± Masukkan nomor WhatsApp kamu terlebih dahulu!');
        document.getElementById('senderPhone').focus();
        return;
    }
    var cleanPhone = normalizePhone(phone);
    if (cleanPhone.length < 10 || cleanPhone.length > 15) {
        alert('âŒ Nomor WhatsApp tidak valid!\nContoh: 08123456789');
        return;
    }
    if (!message) {
        alert('ğŸ’Œ Tulis pesan untuk orang tersayang kamu dulu!');
        document.getElementById('customMessage').focus();
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>Membuat link pendek...';

    var encrypted = encryptData(cleanPhone, message, name);
    var params = 'd=' + encrypted;

    var origin  = window.location.origin;
    var path    = window.location.pathname;
    var isValid = origin && origin !== 'null' && !origin.includes('srcdoc') && origin !== 'about:';
    var base    = isValid ? (origin + path) : 'https://USERNAME.github.io/valentine/index.html';
    var longLink = base + '?' + params;

    // Buat short URL dengan multiple fallback
    var shortLink = await shortenURL(longLink);

    document.getElementById('generatedLink').textContent = shortLink;
    document.getElementById('shortUrlDisplay').textContent = shortLink;
    document.getElementById('linkBox').style.display = 'block';
    document.getElementById('linkBox').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    btn.disabled = false;
    btn.innerHTML = 'ğŸ’ Buat Kartu & Dapatkan Link';
}

function copyLink() {
    var link = document.getElementById('generatedLink').textContent;
    if (!link) return;
    var showFeedback = function() {
        document.getElementById('copyFeedback').textContent = 'âœ… Link berhasil disalin!';
        setTimeout(function() { document.getElementById('copyFeedback').textContent = ''; }, 3000);
    };
    if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(showFeedback).catch(fallbackCopy);
    } else { fallbackCopy(); }
    function fallbackCopy() {
        var el = document.createElement('textarea');
        el.value = link;
        document.body.appendChild(el); el.select();
        document.execCommand('copy'); document.body.removeChild(el);
        showFeedback();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CARD PAGE â€” kirim balasan
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendReply() {
    var replyText = document.getElementById('replyMessage').value.trim();
    var params    = new URLSearchParams(window.location.search);
    var encoded   = params.get('d');
    
    if (!encoded) {
        alert('âŒ Link tidak valid.\nMinta pengirim membuat kartu baru.');
        return;
    }
    
    var data = decryptData(encoded);
    if (!data || !data.w) {
        alert('âŒ Link tidak valid.\nMinta pengirim membuat kartu baru.');
        return;
    }

    if (!replyText) {
        alert('ğŸ’Œ Tulis balasan kamu terlebih dahulu!');
        document.getElementById('replyMessage').focus();
        return;
    }

    var waText = encodeURIComponent(
        '*BALASAN VALENTINE*\n\n' +
        replyText + '\n\n' +
        'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n' +
        'Selamat Hari Valentine!\n' +
        new Date().toLocaleDateString('id-ID', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        })
    );

    window.open('https://wa.me/' + data.w + '?text=' + waText, '_blank');

    setTimeout(function() {
        if (confirm('âœ… WhatsApp telah dibuka!\n\nApakah ingin mengosongkan balasan?')) {
            document.getElementById('replyMessage').value = '';
        }
    }, 800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROUTER â€” setup vs card page
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init() {
    var params = new URLSearchParams(window.location.search);
    var encoded = params.get('d');

    if (encoded) {
        var data = decryptData(encoded);
        
        if (data && data.m) {
            document.getElementById('setupPage').style.display = 'none';
            document.getElementById('cardPage').style.display  = 'block';

            var msgEl = document.getElementById('displayMessage');
            msgEl.innerHTML = escapeHtml(data.m).replace(/\n/g, '<br>') +
                (data.f ? '<div class="author">\u2014 ' + escapeHtml(data.f) + '</div>' : '');
        } else {
            document.getElementById('setupPage').style.display = 'none';
            document.getElementById('cardPage').style.display  = 'block';
            document.getElementById('displayMessage').innerHTML =
                '<span style="color:rgba(255,255,255,0.85);font-size:0.9em">' +
                'âš ï¸ Link tidak valid. Minta pengirim membuat kartu baru.' +
                '</span>';
        }
    } else {
        document.getElementById('setupPage').style.display = 'block';
        document.getElementById('cardPage').style.display  = 'none';
    }
})();

function escapeHtml(str) {
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}
</script>
</body>
</html>